<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="V_wp24xUfrOxgTuCum0w4EXXaddfeQMPvo5e81oncOg" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="monvhh的博客">
    <meta name="keyword"  content="前端 博客 monvhh hexo angular">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          MongoDB 初接触 - monvhh&#39;s Blog
        
    </title>

    <link rel="canonical" href="https://monvhh.github.io/mysite/2017/01/22/MongoDB-初接触/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

    <!-- alice add. test -->
    <script type='text/javascript' src="https://ma.mingces.org/api/ma/ma.js"></script>
  

</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">monvhh&#39;s Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="https://monvhh.github.io/mysite/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg-o.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#技术" title="技术">技术</a>
                        
                          <a class="tag" href="/tags/#TODO" title="TODO">TODO</a>
                        
                          <a class="tag" href="/tags/#NoSQL" title="NoSQL">NoSQL</a>
                        
                    </div>
                    <h1>MongoDB 初接触</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Alice on
                        2017-01-22
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#MongoDB优劣"><span class="post-toc-text">MongoDB优劣</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#dynamic-schemas-动态模式"><span class="post-toc-text">dynamic schemas 动态模式</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#high-availability-and-scalability-高可用性（or有效性）、高扩展"><span class="post-toc-text">high availability and scalability 高可用性（or有效性）、高扩展</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#out-of-the-box-replication-随手可用的复制功能"><span class="post-toc-text">out-of-the-box replication 随手可用的复制功能</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#auto-sharding（自动分区）-或者说-分布式系统"><span class="post-toc-text">auto-sharding（自动分区） 或者说 分布式系统</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#查询速度快"><span class="post-toc-text">查询速度快</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#劣势：不支持复杂的事务"><span class="post-toc-text">劣势：不支持复杂的事务</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#劣势（uncertain）：MongoDB为了性能更快，所以数据会有冗余"><span class="post-toc-text">劣势（uncertain）：MongoDB为了性能更快，所以数据会有冗余</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#what’s-more"><span class="post-toc-text">what’s more</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#MongoDB适用场景，与MySQL对比之下"><span class="post-toc-text">MongoDB适用场景，与MySQL对比之下</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#MongoDB适用"><span class="post-toc-text">MongoDB适用</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#MySQL适用"><span class="post-toc-text">MySQL适用</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#MongoDB-和mySQL一起使用的情况"><span class="post-toc-text">MongoDB 和mySQL一起使用的情况</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#MongoDB结合nodejs的实现"><span class="post-toc-text">MongoDB结合nodejs的实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#MongoDB-Server的安装运行"><span class="post-toc-text">MongoDB Server的安装运行</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用mongo-native（官方驱动）实现nodejs的增（删改查类似就未尝试）"><span class="post-toc-text">使用mongo-native（官方驱动）实现nodejs的增（删改查类似就未尝试）</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用mongoose（ORM）实现nodejs增"><span class="post-toc-text">使用mongoose（ORM）实现nodejs增</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#分析"><span class="post-toc-text">分析</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#遇到的问题"><span class="post-toc-text">遇到的问题</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#MongoDB-gt-MySQL"><span class="post-toc-text">MongoDB -> MySQL</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#阿里云MongoDB"><span class="post-toc-text">阿里云MongoDB</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ELSE"><span class="post-toc-text">ELSE</span></a></li></ol>

                <blockquote>
<p>应工作要求，学习MongoDB，然后需要对结果进行培训验收。本文只针对同事会感兴趣的点。</p>
</blockquote>
<!-- ttoc -->
<h3 id="MongoDB优劣"><a href="#MongoDB优劣" class="headerlink" title="MongoDB优劣"></a>MongoDB优劣</h3><h4 id="dynamic-schemas-动态模式"><a href="#dynamic-schemas-动态模式" class="headerlink" title="dynamic schemas 动态模式"></a>dynamic schemas 动态模式</h4><p>怕翻译的不好，摘录部分原文。</p>
<pre><code>meaning that you can create records without first defining the structure, such as the fields or the types of their values. You can change the structure of records (which we call documents) simply by adding new fields or deleting existing ones. This data model give you the ability to represent hierarchical relationships, to store arrays, and other more complex structures easily. 
flexible data model : your database schema can evolve with business requirements

For example, schema changes that took days of weeks in The Weather Channel&apos;s MySQL databases could be made in just hours with MongoDB.
</code></pre><p>我个人简单粗暴的理解，就是没有结构限制，你不用预先定义结构，也可以随时往一个集合（mongoDB中的集合collection即RDBMS中的table）里存取不同结构的数据。<br>例子中说到对MySQL而言，改变schema需要几天甚至几周，对mongoDB而言只需要几个小时。</p>
<h4 id="high-availability-and-scalability-高可用性（or有效性）、高扩展"><a href="#high-availability-and-scalability-高可用性（or有效性）、高扩展" class="headerlink" title="high availability and scalability 高可用性（or有效性）、高扩展"></a>high availability and scalability 高可用性（or有效性）、高扩展</h4><pre><code>MongoDB can also be scaled within and across multiple distributed data centers
As your deployments grow in terms of data volume and throughput, MongoDB scales easily with no downtime, and without changing your application.
</code></pre><p>随着数据量的增大，MongoDB可以完全没有宕机，无需改变你的应用的扩展</p>
<pre><code>Scalability is not just about speed. It&apos;s about 3 different metrics, which often work together:

* Cluster Scale. Distributing the database across 100+ nodes, often in multiple data centers
* Performance Scale. Sustaining 100,000+ database read and writes per second while maintaining strict latency SLAs
* Data Scale. Storing 1 billion+ documents in the database
</code></pre><p>如何实现需进一步学习。</p>
<h4 id="out-of-the-box-replication-随手可用的复制功能"><a href="#out-of-the-box-replication-随手可用的复制功能" class="headerlink" title="out-of-the-box replication 随手可用的复制功能"></a>out-of-the-box replication 随手可用的复制功能</h4><p>详情参考</p>
<blockquote>
<p><a href="https://docs.mongodb.com/manual/replication/" target="_blank" rel="external">https://docs.mongodb.com/manual/replication/</a></p>
</blockquote>
<p>Replica sets provide redundancy and high availability, and are the basis for all production deployments.<br>这个特性实现了冗余和高可用性。</p>
<h4 id="auto-sharding（自动分区）-或者说-分布式系统"><a href="#auto-sharding（自动分区）-或者说-分布式系统" class="headerlink" title="auto-sharding（自动分区） 或者说 分布式系统"></a>auto-sharding（自动分区） 或者说 分布式系统</h4><p>分布式计算的优点</p>
<ol>
<li><p>可靠性（容错） ：<br> 分布式计算系统中的一个重要的优点是可靠性。一台服务器的系统崩溃并不影响到其余的服务器。</p>
</li>
<li><p>可扩展性：<br> 在分布式计算系统可以根据需要增加更多的机器。</p>
</li>
<li><p>资源共享：<br> 共享数据是必不可少的应用，如银行，预订系统。</p>
</li>
<li><p>灵活性：<br> 由于该系统是非常灵活的，它很容易安装，实施和调试新的服务。</p>
</li>
<li><p>更快的速度：<br> 分布式计算系统可以有多台计算机的计算能力，使得它比其他系统有更快的处理速度。</p>
</li>
<li><p>开放系统：<br> 由于它是开放的系统，本地或者远程都可以访问到该服务。</p>
</li>
<li><p>更高的性能：<br> 相较于集中式计算机网络集群可以提供更高的性能（及更好的性价比）。</p>
</li>
</ol>
<p>分布式计算的缺点</p>
<ol>
<li><p>故障排除：<br> 故障排除和诊断问题。</p>
</li>
<li><p>软件：<br>更少的软件支持是分布式计算系统的主要缺点。</p>
</li>
<li><p>网络：<br>网络基础设施的问题，包括：传输问题，高负载，信息丢失等。</p>
</li>
<li><p>安全性：<br>开发系统的特性让分布式计算系统存在着数据的安全性和共享的风险等问题。</p>
</li>
</ol>
<blockquote>
<p>分区详情参考：<a href="https://docs.mongodb.com/manual/sharding/" target="_blank" rel="external">https://docs.mongodb.com/manual/sharding/</a>  </p>
</blockquote>
<h4 id="查询速度快"><a href="#查询速度快" class="headerlink" title="查询速度快"></a>查询速度快</h4><p>我理解的原因之一是，文档存储方式。比如跟一个用户相关的东西，存储在一个集合（SQL中的表）中，所以相对SQL的多表联合查询，要快。但有冗余的问题。<br>比如产品评论，在产品集合中存了一遍，在用户集合中也存了一遍。</p>
<p>肯定还有其他的原因，需进一步学习。</p>
<p>参考文档：</p>
<blockquote>
<p><a href="https://www.cnblogs.com/crazylights/archive/2013/05/08/3066056.html" target="_blank" rel="external">https://www.cnblogs.com/crazylights/archive/2013/05/08/3066056.html</a></p>
</blockquote>
<h4 id="劣势：不支持复杂的事务"><a href="#劣势：不支持复杂的事务" class="headerlink" title="劣势：不支持复杂的事务"></a>劣势：不支持复杂的事务</h4><p>MongoDB不支持事务，但是mongodb提供了许多原子操作，比如文档的保存，修改，删除等，都是原子操作。</p>
<h4 id="劣势（uncertain）：MongoDB为了性能更快，所以数据会有冗余"><a href="#劣势（uncertain）：MongoDB为了性能更快，所以数据会有冗余" class="headerlink" title="劣势（uncertain）：MongoDB为了性能更快，所以数据会有冗余"></a>劣势（uncertain）：MongoDB为了性能更快，所以数据会有冗余</h4><p>文档存储方式的可能的劣势。</p>
<h4 id="what’s-more"><a href="#what’s-more" class="headerlink" title="what’s more"></a>what’s more</h4><blockquote>
<p><a href="https://www.runoob.com/mongodb/nosql.html" target="_blank" rel="external">https://www.runoob.com/mongodb/nosql.html</a></p>
</blockquote>
<h3 id="MongoDB适用场景，与MySQL对比之下"><a href="#MongoDB适用场景，与MySQL对比之下" class="headerlink" title="MongoDB适用场景，与MySQL对比之下"></a>MongoDB适用场景，与MySQL对比之下</h3><h4 id="MongoDB适用"><a href="#MongoDB适用" class="headerlink" title="MongoDB适用"></a>MongoDB适用</h4><p>The most common use cases for MongoDB include <a href="https://www.mongodb.com/use-cases/single-view" target="_blank" rel="external">Single View</a>, <a href="https://www.mongodb.com/use-cases/internet-of-things" target="_blank" rel="external">Internet of Things</a>, <a href="https://www.mongodb.com/use-cases/mobile" target="_blank" rel="external">Mobile</a>, <a href="https://www.mongodb.com/use-cases/real-time-analytics" target="_blank" rel="external">Real-Time Analytics</a>, <a href="https://www.mongodb.com/use-cases/personalization" target="_blank" rel="external">Personalization</a>, <a href="https://www.mongodb.com/use-cases/catalog" target="_blank" rel="external">Catalog</a>, and <a href="Content Management">Content Management</a>.</p>
<h4 id="MySQL适用"><a href="#MySQL适用" class="headerlink" title="MySQL适用"></a>MySQL适用</h4><p>Applications that require complex, multi-row transactions (e.g., a double-entry bookkeeping system)<br>比如booking system。这种需要强事务性的，需要复杂事务的。</p>
<h4 id="MongoDB-和mySQL一起使用的情况"><a href="#MongoDB-和mySQL一起使用的情况" class="headerlink" title="MongoDB 和mySQL一起使用的情况"></a>MongoDB 和mySQL一起使用的情况</h4><p>比如电商系统中的产品 详情，分类，属性等等，而checkout system（我理解的就是购买和支付等行为）用MySQL</p>
<blockquote>
<p>详情参考：<a href="https://www.mongodb.com/compare/mongodb-mysql" target="_blank" rel="external">https://www.mongodb.com/compare/mongodb-mysql</a></p>
</blockquote>
<h3 id="MongoDB结合nodejs的实现"><a href="#MongoDB结合nodejs的实现" class="headerlink" title="MongoDB结合nodejs的实现"></a>MongoDB结合nodejs的实现</h3><h4 id="MongoDB-Server的安装运行"><a href="#MongoDB-Server的安装运行" class="headerlink" title="MongoDB Server的安装运行"></a>MongoDB Server的安装运行</h4><ol>
<li>安装</li>
<li><p>运行MongoDB服务</p>
<p> <code>mongod</code></p>
</li>
<li><p>打开MongoDB后台管理shell</p>
<p> <code>mongo</code></p>
<blockquote>
<p>用shell操作数据库的方式，如若用代码操作数据库则不用打开shell</p>
</blockquote>
<p> 一些常用指令</p>
  <figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//列出所有db</span></div><div class="line">show dbs</div><div class="line"><span class="comment">//列出当前db</span></div><div class="line"><span class="keyword">db</span></div><div class="line"><span class="comment">//使用某db</span></div><div class="line"><span class="keyword">use</span> <span class="keyword">test</span></div><div class="line"><span class="comment">//列出当前db下所有collection</span></div><div class="line">show collections</div><div class="line"><span class="comment">//显示当前collection中的数据</span></div><div class="line"><span class="keyword">db</span>.collection_name.find().pretty()</div><div class="line"><span class="comment">//针对特殊的collection名</span></div><div class="line"><span class="keyword">db</span>[collection_name].find()</div><div class="line"><span class="keyword">db</span>.getCollection(collection_name).find()</div><div class="line"><span class="comment">//pretty()用于格式化</span></div><div class="line"><span class="comment">//清空collection中的数据，移除整个collection</span></div><div class="line"><span class="keyword">db</span>.collection_name.<span class="keyword">drop</span>()</div><div class="line"><span class="comment">//插入数据</span></div><div class="line"><span class="keyword">db</span>.collection.insert()</div><div class="line"><span class="comment">//Shell help</span></div><div class="line"><span class="keyword">help</span></div><div class="line"><span class="comment">//命令行help</span></div><div class="line">mongo —<span class="keyword">help</span></div><div class="line"><span class="comment">//db help</span></div><div class="line"><span class="keyword">db</span>.<span class="keyword">help</span>()</div><div class="line"><span class="comment">//collection help</span></div><div class="line"><span class="keyword">db</span>.collection.<span class="keyword">help</span>()</div></pre></td></tr></table></figure>
</li>
<li><p>可以启动MongoDB web用户界面</p>
<p> <code>mongod --dbpath=/data/db --rest</code></p>
<p> 默认端口28017： <a href="https://localhost:28017/" target="_blank" rel="external">https://localhost:28017/</a></p>
<blockquote>
<p>不过需要关闭2运行的服务。可能是同一个实例 mongod instance。</p>
</blockquote>
</li>
</ol>
<p>如果以上命令不能直接执行，需要进入mongodb安装目录的bin目录下。取决于安装方式，如果用brew安装的就不需要进入bin目录</p>
<h4 id="使用mongo-native（官方驱动）实现nodejs的增（删改查类似就未尝试）"><a href="#使用mongo-native（官方驱动）实现nodejs的增（删改查类似就未尝试）" class="headerlink" title="使用mongo-native（官方驱动）实现nodejs的增（删改查类似就未尝试）"></a>使用mongo-native（官方驱动）实现nodejs的增（删改查类似就未尝试）</h4><ol>
<li><p>安装</p>
<p> <code>npm install mongodb</code></p>
<blockquote>
<p><a href="https://docs.mongodb.com/getting-started/node/client/" target="_blank" rel="external">https://docs.mongodb.com/getting-started/node/client/</a><br><a href="https://github.com/mongodb/node-mongodb-native?jmp=docs" target="_blank" rel="external">https://github.com/mongodb/node-mongodb-native?jmp=docs</a></p>
</blockquote>
</li>
<li><p>代码</p>
 <figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">var</span> model = &#123;</div><div class="line">    <span class="attribute">uid</span>: json.u,</div><div class="line">    ……</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">var</span> insertDocuments = <span class="function"><span class="keyword">function</span> (<span class="params">db, callback</span>) </span>&#123;</div><div class="line">    <span class="comment">// Get the documents collection</span></div><div class="line">    <span class="built_in">var</span> collection = db.collection(<span class="string">'ma_pv'</span>);</div><div class="line">    <span class="comment">// Insert some documents</span></div><div class="line">    collection.insert(model, <span class="function"><span class="keyword">function</span> (<span class="params">err, result</span>) </span>&#123;</div><div class="line">        assert.equal(err, <span class="literal">null</span>);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">"Inserted documents into the collection"</span>);</div><div class="line">        callback(result);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">var</span> MongoClient = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).MongoClient, assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Connection URL</span></div><div class="line"><span class="built_in">var</span> <span class="built_in">url</span> = <span class="string">'mongodb://localhost:27017/ma'</span>;</div><div class="line"></div><div class="line"><span class="comment">// Use connect method to connect to the server</span></div><div class="line">MongoClient.connect(<span class="built_in">url</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, db</span>) </span>&#123;</div><div class="line">    assert.equal(<span class="literal">null</span>, err);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"Connected successfully to server"</span>);</div><div class="line"></div><div class="line">    insertDocuments(db, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        db.close();</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="使用mongoose（ORM）实现nodejs增"><a href="#使用mongoose（ORM）实现nodejs增" class="headerlink" title="使用mongoose（ORM）实现nodejs增"></a>使用mongoose（ORM）实现nodejs增</h4><ol>
<li><p>安装</p>
<p> <code>npm install mongoose</code></p>
</li>
<li><p>代码</p>
<p> 连接数据库</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</div><div class="line">mongoose.Promise = global.Promise</div><div class="line">mongoose.connect(<span class="string">'mongodb://localhost:27017/ma'</span>);<span class="comment">//；连接数据库</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> db = mongoose.connection;</div><div class="line">db.on(<span class="string">'error'</span>, <span class="built_in">console</span>.error.bind(<span class="built_in">console</span>, <span class="string">'connection error:'</span>));</div><div class="line">db.once(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"we're connected!"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = db;</div></pre></td></tr></table></figure>
<p> 定义model</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</div><div class="line"><span class="keyword">var</span> db = <span class="built_in">require</span>(<span class="string">'./db'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> maPV_schema = mongoose.Schema(&#123;</div><div class="line">    <span class="attr">uid</span>: <span class="built_in">String</span>,</div><div class="line">    ……</div><div class="line">    create_time: <span class="built_in">Date</span></div><div class="line">&#125;); <span class="comment">//  定义了一个新的模型，但是此模式还未和maPV_schema集合有关联</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> maPV = mongoose.model(<span class="string">'maPV'</span>, maPV_schema); <span class="comment">//  与maPV_schema集合关联</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = maPV;</div></pre></td></tr></table></figure>
<p> 数据增</p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> PVmodel = <span class="built_in">require</span>(<span class="string">"../model_mongoose/ma_pv"</span>);</div><div class="line"><span class="keyword">var</span> pvData = <span class="keyword">new</span> PVmodel(&#123;</div><div class="line">    <span class="attr">uid</span>: json.u,</div><div class="line">    ……</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line">pvData.save(<span class="function"><span class="keyword">function</span> (<span class="params">err,pv,num</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">        <span class="built_in">console</span>.error(err)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// throw err;</span></div><div class="line"></div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'pvData saved successfully!'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>what’s more</p>
<pre><code>&gt;https://scotch.io/tutorials/using-mongoosejs-in-node-js-and-mongodb-applications
</code></pre></li>
</ol>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><blockquote>
<p>With Mongoose, everything is derived from a Schema.</p>
</blockquote>
<p>mongoDB是动态schema的，基本就没有schema，无论什么结构的数据都可以往一个集合（collection，相当于RDBMS的table）中存。<br>但是mongoose确是先设定schema，但是后续可以通过mongoose的方法随时更改schema。</p>
<h4 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h4><p>报错：</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(node:<span class="number">21132</span>) DeprecationWarning: Mongoose: mpromise (mongoose<span class="symbol">'s</span> <span class="keyword">default</span> promise <span class="keyword">library</span>) <span class="keyword">is</span> deprecated, plug <span class="keyword">in</span> your own promise <span class="keyword">library</span> instead:</div></pre></td></tr></table></figure>
<p>bugid：<br><a href="https://github.com/Automattic/mongoose/issues/4291" target="_blank" rel="external">https://github.com/Automattic/mongoose/issues/4291</a></p>
<p>临时解决方案：<br>在collect数据库之前 <code>mongoose.Promise = global.Promise</code></p>
<blockquote>
<p><a href="https://stackoverflow.com/questions/38138445/node3341-deprecationwarning-mongoose-mpromise" target="_blank" rel="external">https://stackoverflow.com/questions/38138445/node3341-deprecationwarning-mongoose-mpromise</a></p>
</blockquote>
<h3 id="MongoDB-gt-MySQL"><a href="#MongoDB-gt-MySQL" class="headerlink" title="MongoDB -&gt; MySQL"></a>MongoDB -&gt; MySQL</h3><p>首先，为什么要从MongoDB转移至MySQL?<br>个人考虑，三种情况：</p>
<ol>
<li>通过定时服务，分析MongoDB中的一些数据，存储到MySQL中。这样的话，不需要解决什么技术问题，写API而已，API取数据通过MongoDB的驱动连接MongoDB数据库，存数据通过MySQL的驱动连接MySQl。</li>
<li>如果是把数据直接迁移至MySQL，就只是数据库之间的迁移。但是是否有必要？为什么不直接存储到MySQL</li>
<li><p>如果是为了实时分析数据所以需要迁移至MySQL，MongoDB也支持。</p>
<blockquote>
<p><a href="https://www.mongodb.com/collateral/apache-spark-and-mongodb-turning-analytics-into-real-time-action" target="_blank" rel="external">https://www.mongodb.com/collateral/apache-spark-and-mongodb-turning-analytics-into-real-time-action</a></p>
</blockquote>
</li>
</ol>
<p>所以需要细细考虑，结论如下：</p>
<ol>
<li>只用MongoDB实现：MongoDB好像可以解决所有问题。</li>
<li>部分MongoDB部分MySQL，不涉及迁移问题：根据业务不同使用不同sql。</li>
<li>迁移MySQL。</li>
</ol>
<h3 id="阿里云MongoDB"><a href="#阿里云MongoDB" class="headerlink" title="阿里云MongoDB"></a>阿里云MongoDB</h3><p>除了安装需要按照他们的要求，其他看起来没什么区别；<br>因为没有环境，所以没办法测试。需要阿里云ECS</p>
<h3 id="ELSE"><a href="#ELSE" class="headerlink" title="ELSE"></a>ELSE</h3><ol>
<li><p>架构</p>
<p> <a href="https://www.mongodb.com/collateral/mongodb-architecture-guide" target="_blank" rel="external">https://www.mongodb.com/collateral/mongodb-architecture-guide</a></p>
</li>
<li><p>MongoDB实时分析</p>
<p> <a href="https://www.mongodb.com/collateral/apache-spark-and-mongodb-turning-analytics-into-real-time-action" target="_blank" rel="external">https://www.mongodb.com/collateral/apache-spark-and-mongodb-turning-analytics-into-real-time-action</a></p>
</li>
<li><p>MongoDB结合BI</p>
<p> <a href="https://docs.mongodb.com/bi-connector/master/" target="_blank" rel="external">https://docs.mongodb.com/bi-connector/master/</a></p>
</li>
</ol>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2017/03/24/git-I-used/" data-toggle="tooltip" data-placement="top" title="git I used">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2016/12/28/性能数据：performance/" data-toggle="tooltip" data-placement="top" title="通过performance获取性能数据">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#技术" title="技术">技术</a>
                        
                          <a class="tag" href="/tags/#TODO" title="TODO">TODO</a>
                        
                          <a class="tag" href="/tags/#NoSQL" title="NoSQL">NoSQL</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://www.lizhi.fm/944150/" target="_blank">透明的小角落</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:https://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/monvhh">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://www.linkedin.com/in/monvhh">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; monvhh&#39;s Blog 2017
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("https://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="https://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://monvhh.github.io/mysite/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    var _gaId = 'UA-85271445-1';
    var _gaDomain = 'monvhh.github.io/mysite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = '956eb265cc3068c607b18028ea4e072a';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>


<!-- 友盟统计 -->
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " https://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260890659'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1260890659' type='text/javascript'%3E%3C/script%3E"));</script>


<!-- Side Catalog -->





<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
